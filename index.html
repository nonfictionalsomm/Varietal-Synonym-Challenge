<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cepage Cipher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        .answer-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s, background-color 0.2s, border-color 0.2s, opacity 0.3s;
            cursor: pointer;
            min-height: 80px;
        }
        .answer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .challenge-slot {
            transition: background-color 0.3s, border-color 0.3s;
            height: 90px;
        }
        .challenge-slot.filled {
            background-color: #C6F6D5;
            border-color: #38A169;
        }
        .correct-guess {
            opacity: 0;
            transform: scale(0.5);
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .incorrect-guess {
            animation: shake 0.4s ease-in-out;
            background-color: #FED7D7 !important;
            border-color: #C53030 !important;
        }
        #welcome-modal {
            transition: opacity 0.3s ease-in-out;
        }
        /* Centering for grid containers */
        #challenge-slots, #answer-pool {
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 max-w-lg w-full text-center transform transition-all scale-95 opacity-0" id="modal-content">
            <h2 class="text-3xl font-bold mb-4 text-gray-800">Welcome to Cepage Cipher!</h2>
            <p class="text-gray-600 mb-6">
                Decode the cipher! For the given Primary Grape, find all of its synonyms from the pool below.
            </p>
            <div class="text-left mb-8 space-y-4 bg-gray-50 p-4 rounded-lg border">
                 <p><strong class="text-green-700">Easy Mode:</strong> Find all the synonyms for a given grape.</p>
                <p><strong class="text-purple-700">Hard Mode:</strong> After finding the synonyms, you'll face a follow-up challenge to identify the correct <strong>Region</strong> for one of them!</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="start-easy" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Start Easy Mode
                </button>
                <button id="start-hard" class="w-full bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Start Hard Mode
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Cepage Cipher</h1>
            <div class="mt-4 flex justify-center items-center gap-8">
                <div id="score" class="font-bold text-2xl text-gray-700">Score: 0</div>
                <div id="round-tracker" class="font-semibold text-lg text-gray-500">Round: 1/10</div>
            </div>
        </header>

        <!-- Challenge Area -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div id="challenge-header" class="text-center mb-4">
                <p id="challenge-title" class="text-lg text-gray-600">Primary Grape:</p>
                <h2 id="challenge-grape" class="text-3xl md:text-4xl font-bold text-red-700">-</h2>
            </div>
            <div id="challenge-slots" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                <!-- Empty slots for correct answers go here -->
            </div>
        </div>

        <!-- Answer Pool -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 id="pool-title" class="text-xl font-bold mb-4 text-center">Synonym Pool</h3>
            <div id="answer-pool" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <!-- Answer cards will be generated here -->
            </div>
        </div>
        
        <!-- Feedback Area -->
        <div id="feedback-area" class="text-center min-h-[50px] p-4">
            <p id="feedback-text" class="text-2xl font-bold"></p>
        </div>

    </div>

    <script>
        const rawData = [
            { primary: "Albariño (Spain)", synonym: "Alvarinho", region: "Portugal" },
            { primary: "Altesse", synonym: "Roussette", region: "Savoie" },
            { primary: "Arinto", synonym: "Pederña", region: "Vinho Verde" },
            { primary: "Arneis", synonym: "Nebbiolo Bianco", region: "Piedmont historical name" },
            { primary: "Blauer Portugieser", synonym: "Kékoportó", region: "Hungary" },
            { primary: "Boal", synonym: "Malvasia Fina", region: "Dão" },
            { primary: "Bonarda (Argentina)", synonym: "Charbono", region: "USA" },
            { primary: "Bonarda (Argentina)", synonym: "Corbeau", region: "Ain, Isère, & Jura" },
            { primary: "Bonarda (Argentina)", synonym: "Douce Noire", region: "Savoie" },
            { primary: "Cabernet Franc", synonym: "Bouchet Franc or Gros Bouchet", region: "Right Bank BDX" },
            { primary: "Cabernet Franc", synonym: "Breton", region: "Touraine" },
            { primary: "Cabernet Sauvignon", synonym: "Bouchet or Petit Bouchet", region: "Right Bank BDX" },
            { primary: "Cabernet Sauvignon", synonym: "Vidure or Petite Vidure", region: "Graves" },
            { primary: "Canaiolo Bianco (Tuscany)", synonym: "Drupeggio", region: "Orvieto" },
            { primary: "Carignan", synonym: "Bovale Grande", region: "Sardinia" },
            { primary: "Carignan", synonym: "Carignano", region: "Italy" },
            { primary: "Carignan", synonym: "Mazuelo/a", region: "Rioja" },
            { primary: "Carignan", synonym: "Samsó", region: "Catalunya" },
            { primary: "Carmenère", synonym: "Cabernet Gernischt", region: "China" },
            { primary: "Chardonnay", synonym: "Gamay Blanc", region: "Jura" },
            { primary: "Chardonnay", synonym: "Morillon", region: "Austria" },
            { primary: "Chardonnay", synonym: "Beaunois", region: "Chablis" },
            { primary: "Chasselas", synonym: "Fendant", region: "Valais" },
            { primary: "Chenin Blanc", synonym: "Pineau de la Loire", region: "Loire" },
            { primary: "Chenin Blanc", synonym: "Steen", region: "South Africa" },
            { primary: "Dolcetto", synonym: "Ormeasco", region: "Liguria" },
            { primary: "Fer Servadou", synonym: "Braucol", region: "Gaillac" },
            { primary: "Frühburgunder (Germany)", synonym: "Pinot Noir Précoce", region: "France" },
            { primary: "Furmint", synonym: "Šipon", region: "Slovenia" },
            { primary: "Garganega (Veneto)", synonym: "Grecanico Dorato", region: "Sicily" },
            { primary: "Gewürztraminer", synonym: "Traminer", region: "Alto Adige" },
            { primary: "Grenache", synonym: "Cannonau", region: "Sardinia" },
            { primary: "Grenache", synonym: "Garnacha Tinta", region: "Spain" },
            { primary: "Inzolia (Sicily)", synonym: "Ansonica", region: "Tuscany" },
            { primary: "Lemberger", synonym: "Blaufränkisch", region: "Austria" },
            { primary: "Lemberger", synonym: "Kékfrankos", region: "Hungary" },
            { primary: "Macabeo", synonym: "Viura", region: "Rioja" },
            { primary: "Malbec", synonym: "Côt", region: "Loire" },
            { primary: "Malbec", synonym: "Pressac", region: "St. Émilion" },
            { primary: "Mencía (Spain)", synonym: "Jaen", region: "Portugal" },
            { primary: "Mission (U.S.)", synonym: "País", region: "Chile" },
            { primary: "Mondeuse Noire", synonym: "Grosse Syrah", region: "Jura" },
            { primary: "Mourvèdre (France)", synonym: "Mataró", region: "Catalonia" },
            { primary: "Mourvèdre (France)", synonym: "Monastrell", region: "Spain" },
            { primary: "Muscat Blanc À Petits Grains", synonym: "Moscato Bianco", region: "Italy" },
            { primary: "Muscat of Alexandria", synonym: "Zibibbo", region: "Sicily" },
            { primary: "Nebbiolo", synonym: "Chiavennasca", region: "Valtellina" },
            { primary: "Nebbiolo", synonym: "Spanna", region: "Novara & Vercelli" },
            { primary: "Nero d'Avola", synonym: "Calabrese", region: "Sicily" },
            { primary: "Palomino Fino", synonym: "Listán Blanco", region: "Canary Islands" },
            { primary: "Petite Sirah", synonym: "Durif", region: "France" },
            { primary: "Pinot Blanc", synonym: "Weissburgunder", region: "Germany" },
            { primary: "Pinot Gris", synonym: "Pinot Grigio", region: "Italy" },
            { primary: "Pinot Meunier", synonym: "Müllerrebe", region: "Germany" },
            { primary: "Pinot Noir", synonym: "Spätburgunder", region: "Austria & Germany" },
            { primary: "Riesling", synonym: "Rhine Riesling", region: "Australia & EU" },
            { primary: "Roussanne", synonym: "Bergeron", region: "Savoie" },
            { primary: "Sangiovese", synonym: "Brunello", region: "Montalcino" },
            { primary: "Sangiovese", synonym: "Morellino", region: "Maremma" },
            { primary: "Sangiovese", synonym: "Nielluccio", region: "Corsica" },
            { primary: "Sauvignon Blanc", synonym: "Fumé Blanc", region: "Sancerre & Pouilly-Fume" },
            { primary: "Sémillon", synonym: "Hunter River Riesling", region: "Australia" },
            { primary: "Tannat", synonym: "Harriague", region: "Uruguay" },
            { primary: "Tempranillo", synonym: "Aragonez", region: "Alentejo" },
            { primary: "Tempranillo", synonym: "Cencibel", region: "La Mancha" },
            { primary: "Tempranillo", synonym: "Tinta Roriz", region: "Douro" },
            { primary: "Tempranillo", synonym: "Tinto de Toro", region: "Toro" },
            { primary: "Tibouren (Provence)", synonym: "Rossese di Dolceacqua", region: "Liguria" },
            { primary: "Trebbiano Toscano", synonym: "Ugni Blanc", region: "France, Croatia, & Uruguay" },
            { primary: "Trollinger (Württemberg)", synonym: "Schiava Grossa", region: "Italy" },
            { primary: "Trousseau", synonym: "Bastardo", region: "Portugal" },
            { primary: "Verdicchio", synonym: "Trebbiano di Soave", region: "Veneto" },
            { primary: "Vermentino", synonym: "Pigato", region: "Liguria" },
            { primary: "Welschriesling", synonym: "Olaszrizling", region: "Hungary" },
            { primary: "Xarel·lo", synonym: "Pansa Blanca", region: "Catalunya" },
            { primary: "Zinfandel", synonym: "Primitivo", region: "Italy" }
        ];

        const primaryData = rawData.reduce((acc, item) => {
            if (!acc[item.primary]) {
                acc[item.primary] = { synonyms: [] };
            }
            acc[item.primary].synonyms.push({ name: item.synonym, region: item.region });
            return acc;
        }, {});

        const allPrimaries = Object.keys(primaryData);
        const allSynonyms = rawData.map(item => item.synonym);
        const allRegions = [...new Set(rawData.map(item => item.region))];

        // DOM Elements
        const welcomeModal = document.getElementById('welcome-modal');
        const modalContent = document.getElementById('modal-content');
        const startEasyBtn = document.getElementById('start-easy');
        const startHardBtn = document.getElementById('start-hard');
        const challengeTitleEl = document.getElementById('challenge-title');
        const challengeGrapeEl = document.getElementById('challenge-grape');
        const challengeSlotsEl = document.getElementById('challenge-slots');
        const answerPoolEl = document.getElementById('answer-pool');
        const poolTitleEl = document.getElementById('pool-title');
        const scoreEl = document.getElementById('score');
        const roundTrackerEl = document.getElementById('round-tracker');
        const feedbackTextEl = document.getElementById('feedback-text');

        // Game State
        let currentMode = 'hard';
        let score = 0;
        let currentRound = 0;
        const TOTAL_ROUNDS = 10;
        let gameChallenges = [];
        let currentChallenge = {};
        let foundSynonymsCount = 0;
        let roundStage = 'cipher'; // 'cipher' or 'context'
        let incorrectSynonymGuesses = new Set();

        function showWelcomeModal() {
            welcomeModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 50);
        }

        function hideWelcomeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                welcomeModal.classList.add('hidden');
            }, 300);
        }

        function startGame(mode) {
            hideWelcomeModal();
            currentMode = mode;
            score = 0;
            currentRound = 0;
            updateScore();
            gameChallenges = shuffle(allPrimaries).slice(0, TOTAL_ROUNDS);
            nextRound();
        }

        function nextRound() {
            if (currentRound >= TOTAL_ROUNDS) {
                endGame();
                return;
            }
            
            feedbackTextEl.textContent = '';
            roundStage = 'cipher';
            
            const challengeGrapeName = gameChallenges[currentRound];
            currentRound++;
            roundTrackerEl.textContent = `Round: ${currentRound}/${TOTAL_ROUNDS}`;
            
            currentChallenge = {
                primary: challengeGrapeName,
                synonyms: primaryData[challengeGrapeName].synonyms
            };
            foundSynonymsCount = 0;
            incorrectSynonymGuesses.clear();

            displayCipherChallenge();
        }

        function displayCipherChallenge() {
            challengeTitleEl.textContent = 'Primary Grape:';
            challengeGrapeEl.textContent = currentChallenge.primary;
            challengeGrapeEl.className = 'text-3xl md:text-4xl font-bold text-red-700';
            poolTitleEl.textContent = 'Synonym Pool';
            
            challengeSlotsEl.innerHTML = '';
            currentChallenge.synonyms.forEach((_, i) => {
                const slot = document.createElement('div');
                slot.id = `slot-${i}`;
                slot.className = 'challenge-slot bg-gray-200 rounded-lg p-2 border-2 border-dashed border-gray-400 flex items-center justify-center';
                challengeSlotsEl.appendChild(slot);
            });

            answerPoolEl.innerHTML = '';
            const numHerrings = currentMode === 'easy' ? 8 : 12;
            const correctAnswers = currentChallenge.synonyms.map(s => s.name);
            const herrings = generateHerrings(correctAnswers, allSynonyms, numHerrings);
            const options = shuffle([...correctAnswers, ...herrings]);

            options.forEach(text => {
                const card = createAnswerCard(text);
                card.addEventListener('click', () => selectSynonymAnswer(card, text));
                answerPoolEl.appendChild(card);
            });
        }

        function selectSynonymAnswer(selectedCard, text) {
            if (selectedCard.disabled) return;

            const isCorrect = currentChallenge.synonyms.some(s => s.name === text);

            if (isCorrect) {
                score += 10;
                selectedCard.classList.add('correct-guess');
                selectedCard.disabled = true;

                const slot = document.getElementById(`slot-${foundSynonymsCount}`);
                if (slot) {
                    slot.textContent = text;
                    slot.classList.add('filled', 'font-semibold', 'text-gray-800');
                }
                foundSynonymsCount++;

                if (foundSynonymsCount === currentChallenge.synonyms.length) {
                    feedbackTextEl.textContent = 'Cipher Complete!';
                    feedbackTextEl.className = 'text-2xl font-bold text-green-600';
                    if (currentMode === 'hard') {
                        setTimeout(startContextStage, 2000);
                    } else {
                        setTimeout(nextRound, 2000);
                    }
                }
            } else {
                score -= 2;
                incorrectSynonymGuesses.add(text);
                selectedCard.classList.add('incorrect-guess');
                setTimeout(() => selectedCard.classList.remove('incorrect-guess'), 1000);
            }
            updateScore();
        }
        
        function startContextStage() {
            roundStage = 'context';
            feedbackTextEl.textContent = '';
            
            const firstTryCorrectSynonyms = currentChallenge.synonyms.filter(s => !incorrectSynonymGuesses.has(s.name));
            const eligibleSynonyms = firstTryCorrectSynonyms.length > 0 ? firstTryCorrectSynonyms : currentChallenge.synonyms;
            
            const contextChallengeSynonym = shuffle(eligibleSynonyms)[0];
            currentChallenge.contextAnswer = contextChallengeSynonym.region;

            challengeTitleEl.textContent = 'Context Challenge:';
            challengeGrapeEl.textContent = `What is the region for the synonym "${contextChallengeSynonym.name}"?`;
            challengeGrapeEl.className = 'text-xl md:text-2xl font-semibold text-gray-800';

            challengeSlotsEl.innerHTML = '';
            answerPoolEl.innerHTML = '';
            poolTitleEl.textContent = 'Region Pool';
            
            const numHerrings = 5;
            const herrings = generateHerrings([currentChallenge.contextAnswer], allRegions, numHerrings);
            const options = shuffle([currentChallenge.contextAnswer, ...herrings]);

            options.forEach(text => {
                const card = createAnswerCard(text);
                card.addEventListener('click', () => selectContextAnswer(card, text));
                answerPoolEl.appendChild(card);
            });
        }

        function selectContextAnswer(selectedCard, text) {
            answerPoolEl.querySelectorAll('button').forEach(b => b.disabled = true);

            if (text === currentChallenge.contextAnswer) {
                score += 15;
                selectedCard.classList.add('correct-guess');
                feedbackTextEl.textContent = 'Region Correct!';
                feedbackTextEl.className = 'text-2xl font-bold text-green-600';
            } else {
                score -= 5;
                selectedCard.classList.add('incorrect-guess');
                feedbackTextEl.textContent = `Incorrect. The answer was ${currentChallenge.contextAnswer}.`;
                feedbackTextEl.className = 'text-xl font-bold text-red-600';
                
                 answerPoolEl.querySelectorAll('button').forEach(b => {
                    if (b.textContent === currentChallenge.contextAnswer) {
                        b.classList.add('correct-guess');
                        b.style.opacity = 1; // Make sure it's visible
                    }
                });
            }
            updateScore();
            setTimeout(nextRound, 3000);
        }

        function generateHerrings(correctAnswers, sourceArray, count) {
            const herrings = new Set();
            while (herrings.size < count) {
                const randomItem = sourceArray[Math.floor(Math.random() * sourceArray.length)];
                if (!correctAnswers.includes(randomItem)) {
                    herrings.add(randomItem);
                }
            }
            return Array.from(herrings);
        }

        function createAnswerCard(text) {
            const card = document.createElement('button');
            card.className = 'answer-card bg-white rounded-lg p-2 shadow border flex items-center justify-center text-center';
            card.textContent = text;
            return card;
        }
        
        function endGame() {
            challengeTitleEl.textContent = 'Game Over!';
            challengeGrapeEl.textContent = '';
            challengeSlotsEl.innerHTML = '';
            answerPoolEl.innerHTML = '';
            feedbackTextEl.textContent = `Final Score: ${score}`;
            feedbackTextEl.insertAdjacentHTML('afterend', `<div class="text-center mt-4"><button id="play-again" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-lg">Play Again</button></div>`);
            document.getElementById('play-again').addEventListener('click', showWelcomeModal);
        }
        
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function updateScore() {
            scoreEl.textContent = `Score: ${score}`;
        }

        // --- Initial Setup ---
        startEasyBtn.addEventListener('click', () => startGame('easy'));
        startHardBtn.addEventListener('click', () => startGame('hard'));
        
        window.addEventListener('load', showWelcomeModal);

    </script>
</body>
</html>
